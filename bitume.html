<!doctype html>
<html>
<head>
	<title>Bitume MKV</title>
	<meta charset='utf-8'/>
	<link rel='stylesheet' href='bitume.css'/>
	<script>

var ATTRIBUTES = {
	'primary' : [
		'FO', 'AG', 'RA', 'EN',
		'PR', 'PE', 'IN', 'BE',
	],
	'secondary' : [
		'SI', 'PV', 'PP', 'CH',
	],
	'skill' : {
		'ACR': ['AG', 'PR'],
		'COM': ['AG', 'FO'],
		'CON': ['PR', 'RA'],
		'DIS': ['AG', 'IN'],
		'LAN': ['FO', 'PR'],
		'MAR': ['BE', 'PE'],
		'MEC': ['IN', 'RA'],
		'PRE': ['PE', 'RA'],
		'REP': ['IN', 'PE'],
		'RES': ['EN', 'FO'],
		'SED': ['BE', 'FO/AG'],
		'TIR': ['PE', 'PR'],
	},
}

var GENDER = {
	'female': { 
		'FO': -1, 
		'AG': +1, 
	},
	'male': { 
		'FO': +1, 
		'AG': -1, 
	},
};

var TRIBE = {
	'amazone': {
		'RA': +1, 'BE': +1,
		'DIS': +10, 'MAR': -20, 'TIR': +20,
	},
	'mercenaire': {
		'RA': +1, 'PR': +1, 'PE': +1,
		'COM': +10, 'CON': +10, 'LAN': +5, 'TIR': +10,
	},
};

var MODIFS = {
	FO:0, AG:0, RA:0, EN:0,
	PR:0, PE:0, IN:0, BE:0,
	ACR:0, COM:0, CON:0,
	DIS:0, LAN:0, MAR:0,
	MEC:0, PRE:0, REP:0,
	RES:0, SED:0, TIR:0,
}

var POINTS = {
	FO:5, AG:5, RA:5, EN:5,
	PR:5, PE:5, IN:5, BE:5,
	ACR:0, COM:0, CON:0,
	DIS:0, LAN:0, MAR:0,
	MEC:0, PRE:0, REP:0,
	RES:0, SED:0, TIR:0,
}

var PC = { };

var MAXIMUM_PRIMARY_POINTS = 40;
var MAXIMUM_PPE = 50;
var gCurrentPPE = MAXIMUM_PPE;

function dumpPC() {
	console.log("----------------------------------------"
		+"\n--- FINAL PC ("+PC.gender+" "+PC.tribe+"):\n"
		+'FO:'+PC.FO+' AG:'+PC.AG+' RA:'+PC.RA+' EN:'+PC.EN+' '
		+'PR:'+PC.PR+' PE:'+PC.PE+' IN:'+PC.IN+' BE:'+PC.BE+'\n'
		+'ACR:'+PC.ACR+' COM:'+PC.COM+' CON:'+PC.CON+' '
		+'DIS:'+PC.DIS+' LAN:'+PC.LAN+' MAR:'+PC.MAR+' '
		+'MEC:'+PC.MEC+' PRE:'+PC.PRE+' REP:'+PC.REP+' '
		+'RES:'+PC.RES+' SED:'+PC.SED+' TIR:'+PC.TIR+' '
		+"\n--- POINTS:\n"
		+'FO:'+POINTS.FO+' AG:'+POINTS.AG+' RA:'+POINTS.RA+' EN:'+POINTS.EN+' '
		+'PR:'+POINTS.PR+' PE:'+POINTS.PE+' IN:'+POINTS.IN+' BE:'+POINTS.BE+'\n'
		+'ACR:'+POINTS.ACR+' COM:'+POINTS.COM+' CON:'+POINTS.CON+' '
		+'DIS:'+POINTS.DIS+' LAN:'+POINTS.LAN+' MAR:'+POINTS.MAR+' '
		+'MEC:'+POINTS.MEC+' PRE:'+POINTS.PRE+' REP:'+POINTS.REP+' '
		+'RES:'+POINTS.RES+' SED:'+POINTS.SED+' TIR:'+POINTS.TIR+' '
		+"\n--- MODIFS:\n"
		+'FO:'+MODIFS.FO+' AG:'+MODIFS.AG+' RA:'+MODIFS.RA+' EN:'+MODIFS.EN+' '
		+'PR:'+MODIFS.PR+' PE:'+MODIFS.PE+' IN:'+MODIFS.IN+' BE:'+MODIFS.BE+'\n'
		+'ACR:'+MODIFS.ACR+' COM:'+MODIFS.COM+' CON:'+MODIFS.CON+' '
		+'DIS:'+MODIFS.DIS+' LAN:'+MODIFS.LAN+' MAR:'+MODIFS.MAR+' '
		+'MEC:'+MODIFS.MEC+' PRE:'+MODIFS.PRE+' REP:'+MODIFS.REP+' '
		+'RES:'+MODIFS.RES+' SED:'+MODIFS.SED+' TIR:'+MODIFS.TIR+' '
		+"\n----------------------------------------"
	);
}

function getAttributeType(id) {
	if (id == 'FO' || id == 'AG' || id == 'RA' || id == 'EN'
	 || id == 'PR' || id == 'PE' || id == 'IN' || id == 'BE')
		return 'primary';
	if (id == 'ACR' || id == 'COM' || id == 'CON'
	 || id == 'DIS' || id == 'LAN' || id == 'MAR'
	 || id == 'MEC' || id == 'PRE' || id == 'REP'
	 || id == 'RES' || id == 'SED' || id == 'TIR')
		return 'skill';
	throw "Unknown attribute \""+id+"\"";
}

function getCurrentPrimaryPoints() {
	return POINTS.FO + POINTS.AG + POINTS.RA + POINTS.EN
		 + POINTS.PR + POINTS.PE + POINTS.IN + POINTS.BE;
}

function getAvailablePoints(type) {
	if (type == 'primary' )
		return MAXIMUM_PRIMARY_POINTS - getCurrentPrimaryPoints();
	if (type == 'skill')
		return gCurrentPPE;
}

function getBaseSkill(id) {
	var l = ATTRIBUTES['skill'][id];
	var res = (PC[l[0]] + PC[l[1]])*5;
	return res;
}

function updatePCAttribute(id) {
	switch (id) {
		case 'FO':
		case 'AG':
		case 'RA':
		case 'EN':
		case 'PR':
		case 'PE':
		case 'IN':
		case 'BE':
			PC[id] = MODIFS[id] + POINTS[id];
			break;
		case 'SI':
			PC[id] = PC['EN'];
			break;
		case 'PV':
			PC[id] = 4 * PC['EN'];
			break;
		case 'PP':
			PC[id] = PC['IN'] + PC['BE'];
			break;
		case 'CH':
			PC[id] = (PC['FO'] + PC['EN']) *1.5;
			break;
		default:
			PC[id] = getBaseSkill(id) + MODIFS[id] + POINTS[id];
			break;
	}
}

function getDefaultMaximum(type) {
	if (type == 'primary') return 10;
	if (type == 'skill') return 100;
}

function getMaximum(id) {
	var malus = 0
	if(MODIFS[id] < 0) malus = -MODIFS[id];
	var type = getAttributeType(id);
	return getDefaultMaximum(type) - malus;
}

function getDefaultMinimum(id) {
	var type = getAttributeType(id);
	if (type == 'primary') return 1;
	if (type == 'skill') return getBaseSkill(id);
}

function getMinimum(id, type) {
	var default_minimum = getDefaultMinimum(id);
	if (type == 'skill') return default_minimum + MODIFS[id];
	var bonus = 0;
	if (MODIFS[id] > 0) bonus = MODIFS[id];
	return default_minimum + bonus;
}

function updateMinMaxAndValue(id) {
	var e = document.getElementById(id);
	e.value = PC[id];
	var type = getAttributeType(id);
	var max = e.valueAsNumber + getAvailablePoints(type);
	e.max = Math.min(getMaximum(id), max);
	e.min = getMinimum(id, type);
}

function updateModifier(op, modifiers, id, key) {
	if(!modifiers[key]) return; //DO nothing
	if(op == '-') {
		MODIFS[id] -= modifiers[key][id];
	} else
	if(op == '+') {
		MODIFS[id] += modifiers[key][id];
	} else throw "Unknown operator \""+op+"\"";
	updatePCAttribute(id);
	updateMinMaxAndValue(id);
}

function letsTalkAboutSED() {
	var SED_attribute = 'FO';
	if (PC.gender == 'female') SED_attribute = 'AG';
	ATTRIBUTES['skill']['SED'][1] = SED_attribute;
	document.getElementById('SEDformula').innerHTML = "SED = (BE + "+SED_attribute+") × 5";
}

function onGender(selector) {
	var new_gender = selector.value;
	if(!new_gender) throw "Unkown gender \""+new_gender+"\"";
	if(new_gender == PC.gender) return; //DO nothing
	var attributes = ['FO', 'AG'];
	for (var i = 0; i < attributes.length; i++) {
		var id = attributes[i];
		updateModifier('-', GENDER, id, PC.gender);
		updateModifier('+', GENDER, id, new_gender);
	}
	PC.gender = new_gender;
	letsTalkAboutSED();
	updatePC();
}

function updateTribe(op, tribe) {
	var attributes = Object.keys(TRIBE[tribe]);
	for (var i = 0; i < attributes.length; i++) {
		updateModifier(op, TRIBE, attributes[i], tribe);
	}
}

function onTribe(selector) {
	var new_tribe = selector.value;
	if(!new_tribe) throw "Unkown tribe \""+new_tribe+"\"";
	if(new_tribe == PC.tribe) return; //DO nothing
	if(PC.tribe) updateTribe('-', PC.tribe);
	updateTribe('+', new_tribe);
	PC.tribe = new_tribe;
	updatePC();
}

function updateSecondaryValue(id) {
	var e = document.getElementById(id);
	e.innerHTML = PC[id];
}


function updatePC() {
	for (var i = 0; i < ATTRIBUTES['primary'].length; i++) {
		var id = ATTRIBUTES['primary'][i];
		updatePCAttribute(id);
		updateMinMaxAndValue(id);
	}
	for (var i = 0; i < ATTRIBUTES['secondary'].length; i++) {
		var id = ATTRIBUTES['secondary'][i];
		updatePCAttribute(id);
		updateSecondaryValue(id);
	}
	var skills = Object.keys(ATTRIBUTES['skill']);
	for (var i = 0; i < skills.length; i++) {
		var id = skills[i];
		updatePCAttribute(id);
		updateMinMaxAndValue(id);
	}
	dumpPC();
}

function onAttribute(selector) {
	var id = selector.id;
	POINTS[id] += (selector.valueAsNumber - PC[id]);
	updatePCAttribute(id);
	updatePC();
}

function loadPC() {
	onGender(document.getElementById('gender'));
	onTribe(document.getElementById('tribe'));
	updatePC();
}
	</script>
</head>
<body onload="loadPC()">

<div class='main'>

<h1 class='framed' style='border-width: 5px;'>BITUME</h1>

<div class='column-left framed'>
	<section id='general'>
		<div class='attribute'>
			<label for='name'>NOM</label>
			<input type='text' id='name'>
		</div>
		<div class='attribute'>
			<label for='gender'>SEXE</label>
			<select id='gender' class='combobox' onchange="onGender(this)">
				<option value='female'>Femme</option>
				<option value='male'>Homme</option>
			</select>
		</div>
		<div class='attribute'>
			<label for='tribe'>TRIBU</label>
			<select id='tribe' class='combobox' onchange="onTribe(this)">
				<option value='amazone'>Amazone</option>
				<option value='mercenaire'>Mercenaire</option>
			</select>
		</div>
		<div class='attribute'>
			<label for='goal'>BUT</label>
			<input type='text' id='goal'>
		</div>
		<!-- TODO: description -->
	</section>

	<section id='attrs'>
		<h2>CARACTÉRISTIQUES <br/>PRIMAIRES</h2>
		<div class='attribute'>
			<label for='FO'>FORCE (FO)</label>
			<input id='FO' type='number' class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<label for='AG'>AGILITÉ (AG)</label>
			<input id='AG' type='number' class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<label for='RA'>RAPIDITÉ (RA)</label>
			<input id='RA' type='number' class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<label for='EN'>ENDURANCE (EN)</label>
			<input id='EN' type='number' class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<label for='PR'>PRÉCISION (PR)</label>
			<input id='PR' type='number' class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<label for='PE'>PERCEPTION (PE)</label>
			<input id='PE' type='number' class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<label for='IN'>INTELLIGENCE (IN)</label>
			<input id='IN' type='number' class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<label for='BE'>BEAUTÉ (BE)</label>
			<input id='BE' type='number' class='changer' onchange="onAttribute(this)">
		</div>
	</section>
</div> <!-- end left column-->


<div class='column-right framed'>
	<section>
		<h2>CARACTÉRISTIQUES <br/> SECONDAIRES</h2>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='SI'>SEUIL D'INCONSCIENCE (SI)</label>
				<span>SI = EN</span>
			</div>
			<div id='SI' class='value'>6</div>
		</div>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='PV'>POINTS DE VIE (PV)</label>
				<span>PV = EN × 4</span>
			</div>
			<div id='PV' class='value'>24</div>
		</div>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='PP'>POINTS DE PRESTIGE (PP)</label>
				<span>PP = IN + BE</span>
			</div>
			<div id='PP' class='value'>7</div>
		</div>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='CH'>CHARGE (CH)</label>
				<span>CH = (FO + EN) × 1.5</span>
			</div>
			<div id='CH' class='value'>15</div>
		</div>
	</section>
	<section>
		<h2>TALENTS</h2>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='ACR'>ACROBATIE (ACR)</label>
				<span>ACR = (AG + PR) × 5</span>
			</div>
			<input id='ACR' type='number' step=5 class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='COM'>COMBAT (COM)</label>
				<span>COM = (AG + FO) × 5</span>
			</div>
			<input id='COM' type='number' step=5 class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='CON'>CONDUITE (CON)</label>
				<span>CON = (PR + RA) × 5</span>
			</div>
			<input id='CON' type='number' step=5 class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='DIS'>DISCRETION (DIS)</label>
				<span>DIS = (AG + IN) × 5</span>
			</div>
			<input id='DIS' type='number' step=5 class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='LAN'>LANCER (LAN)</label>
				<span>LAN = (FO + PR) × 5</span>
			</div>
			<input id='LAN' type='number' step=5 class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='MAR'>MARCHANDAGE (MAR)</label>
				<span>MAR = (BE + PE) × 5</span>
			</div>
			<input id='MAR' type='number' step=5 class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='MEC'>MÉCANIQUE (MEC)</label>
				<span>MEC = (IN + RA) × 5</span>
			</div>
			<input id='MEC' type='number' step=5 class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='PRE'>PREMIERS SOINS (PRE)</label>
				<span>PRE = (PE + RA) × 5</span>
			</div>
			<input id='PRE' type='number' step=5 class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='REP'>REPÉRAGE (REP)</label>
				<span>REP = (IN + PE) × 5</span>
			</div>
			<input id='REP' type='number' step=5 class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='RES'>RÉSISTANCE (RES)</label>
				<span>RES = (EN + FO) × 5</span>
			</div>
			<input id='RES' type='number' step=5 class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='SED'>SÉDUCTION (SED)</label>
				<span id='SEDformula'>SED = (BE + FO/AG) × 5</span>
			</div>
			<input id='SED' type='number' step=5 class='changer' onchange="onAttribute(this)">
		</div>
		<div class='attribute'>
			<div class='nameandformula'>
				<label for='TIR'>TIR (TIR)</label>
				<span>TIR = (PE + PR) × 5</span>
			</div>
			<input id='TIR' type='number' step=5 class='changer' onchange="onAttribute(this)">
		</div>
	</section>
</div> <!-- end right column-->

<div class='column-central'>
	<div class='road'>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
		<div class='dot'>|</div>
	</div>
</div> <!-- end central column-->

</div> <!-- end main-->


</body>
